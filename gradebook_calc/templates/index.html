<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GradebookCalc (Modular)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .load-button {
            cursor: pointer; display: inline-block; padding: 0.5rem 1rem; transition: all 0.2s ease-in-out;
        }
        .table-container { max-height: 60vh; overflow-y: auto; }
        .load-button, .calc-button {
            background-color: #2563EB; color: white; font-weight: 500; border-radius: 0.375rem;
        }
        .load-button:hover, .calc-button:hover { background-color: #1D4ED8; }
        .load-button:disabled, .calc-button:disabled { background-color: #9CA3AF; cursor: not-allowed; }
        .radio-label { display: block; padding: 0.5rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; cursor: pointer; }
        .radio-label:hover { background-color: #F7FAFC; }
        input[type="radio"]:checked + .radio-label { background-color: #DBEAFE; border-color: #60A5FA; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08H4.125a2.25 2.25 0 0 0-2.25 2.25v11.54A2.25 2.25 0 0 0 4.125 21h11.75c.621 0 1.178-.252 1.584-.658a2.246 2.246 0 0 1 .372-.832l-1.44-1.44M9 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                        <h1 class="text-2xl font-bold text-gray-900">GradebookCalc</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
            <div id="content-area" class="space-y-8">
                
                <!-- Step 1: Curriculum Loader -->
                <div id="curriculum-loader" class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Step 1: Select a Curriculum File</h3>
                    <div id="curriculum-file-list" class="space-y-2 mb-4">
                        <p class="text-gray-500">Loading available files...</p>
                    </div>
                    <button id="load-curriculum-btn" class="load-button" disabled>Load Selected Curriculum</button>
                    <p id="curriculum-summary" class="text-sm text-green-600 mt-2 font-medium"></p>
                </div>

                <!-- Step 2: Grades Loader -->
                <div id="grades-loader" class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Step 2: Select a Grades File</h3>
                    <div id="grades-file-list" class="space-y-2 mb-4">
                        <p class="text-gray-500">Loading available files...</p>
                    </div>
                    <button id="load-grades-btn" class="load-button" disabled>Load Selected Grades</button>
                    <p id="grades-summary" class="text-sm text-green-600 mt-2 font-medium"></p>
                </div>
                
                <!-- Step 3: Calculation -->
                <div id="action-bar" class="text-center bg-white p-4 rounded-lg shadow">
                     <h3 class="text-lg font-semibold text-gray-800 mb-2">Step 3: Calculate</h3>
                    <button id="calculate-btn" class="calc-button text-base px-6 py-2" disabled>Calculate Final Grades</button>
                    <p id="status-text" class="text-sm text-gray-500 mt-2">Please complete steps 1 and 2.</p>
                </div>

                <!-- Results Display -->
                <div id="results-display" class="hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Final Grades</h3>
                    <div id="results-content" class="bg-white p-6 rounded-lg shadow"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for messages -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-20">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"></div>
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-2"></h3>
                <div class="mt-2 px-7 py-3"><p id="modal-message" class="text-sm text-gray-500"></p></div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 w-full">Close</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- State Management ---
    const appState = { curriculumLoaded: false, gradesLoaded: false };

    // --- DOM References ---
    const curriculumListDiv = document.getElementById('curriculum-file-list');
    const loadCurriculumBtn = document.getElementById('load-curriculum-btn');
    const curriculumSummary = document.getElementById('curriculum-summary');
    
    const gradesListDiv = document.getElementById('grades-file-list');
    const loadGradesBtn = document.getElementById('load-grades-btn');
    const gradesSummary = document.getElementById('grades-summary');
    
    const calculateBtn = document.getElementById('calculate-btn');
    const statusText = document.getElementById('status-text');
    const resultsDisplay = document.getElementById('results-display');
    const resultsContent = document.getElementById('results-content');
    
    // --- Modal Logic ---
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalIcon = document.getElementById('modal-icon');
    const modalClose = document.getElementById('modal-close');
    modalClose.addEventListener('click', () => modal.classList.add('hidden'));

    function showModal(title, message, isError = true) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        const icon_err = `<svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`;
        const icon_ok = `<svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`;
        modalIcon.innerHTML = isError ? icon_err : icon_ok;
        modalIcon.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${isError ? 'bg-red-100' : 'bg-green-100'}`;
        modal.classList.remove('hidden');
    }

    // --- Core Application Logic ---
    function updateUIState() {
        const bothLoaded = appState.curriculumLoaded && appState.gradesLoaded;
        calculateBtn.disabled = !bothLoaded;
        statusText.textContent = bothLoaded ? 'Ready to calculate.' : 'Please complete steps 1 and 2.';
    }

    async function fetchAndDisplayFiles(endpoint, listDiv, loadBtn, radioName) {
        try {
            const response = await fetch(endpoint);
            if (!response.ok) throw new Error(`Could not fetch file list from ${endpoint}`);
            const files = await response.json();
            
            listDiv.innerHTML = ''; // Clear loading message
            if (files.length === 0) {
                listDiv.innerHTML = `<p class="text-red-500">No ${radioName} files found on server.</p>`;
                return;
            }

            files.forEach(file => {
                const id = `${radioName}-${file.replace(/\./g, '-')}`;
                const radioDiv = document.createElement('div');
                radioDiv.innerHTML = `
                    <input type="radio" name="${radioName}_file" value="${file}" id="${id}" class="hidden">
                    <label for="${id}" class="radio-label">${file}</label>
                `;
                listDiv.appendChild(radioDiv);
            });

            listDiv.addEventListener('change', () => {
                loadBtn.disabled = false;
            });

        } catch (error) {
            listDiv.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        }
    }

    loadCurriculumBtn.addEventListener('click', async () => {
        const selectedFile = document.querySelector('input[name="curriculum_file"]:checked');
        if (!selectedFile) {
            showModal('Error', 'Please select a curriculum file to load.');
            return;
        }
        
        loadCurriculumBtn.disabled = true;
        loadCurriculumBtn.textContent = 'Loading...';

        try {
            const response = await fetch('/api/load/curriculum', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: selectedFile.value })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            
            appState.curriculumLoaded = true;
            curriculumSummary.textContent = result.summary;

        } catch (error) {
            showModal('Load Error', error.message);
            appState.curriculumLoaded = false;
            curriculumSummary.textContent = '';
        } finally {
            loadCurriculumBtn.disabled = false;
            loadCurriculumBtn.textContent = 'Load Selected Curriculum';
            updateUIState();
        }
    });
    
    loadGradesBtn.addEventListener('click', async () => {
        const selectedFile = document.querySelector('input[name="grades_file"]:checked');
        if (!selectedFile) {
            showModal('Error', 'Please select a grades file to load.');
            return;
        }
        
        loadGradesBtn.disabled = true;
        loadGradesBtn.textContent = 'Loading...';

        try {
            const response = await fetch('/api/load/grades', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: selectedFile.value })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            
            appState.gradesLoaded = true;
            gradesSummary.textContent = result.summary;

        } catch (error) {
            showModal('Load Error', error.message);
            appState.gradesLoaded = false;
            gradesSummary.textContent = '';
        } finally {
            loadGradesBtn.disabled = false;
            loadGradesBtn.textContent = 'Load Selected Grades';
            updateUIState();
        }
    });

    calculateBtn.addEventListener('click', async () => {
        calculateBtn.disabled = true;
        calculateBtn.textContent = 'Calculating...';

        try {
            const response = await fetch('/api/calculate', { method: 'POST' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);

            displayResults(result.data);
            showModal('Success', 'Calculation complete.', false);
            
            // Reset for next run
            appState.curriculumLoaded = false;
            appState.gradesLoaded = false;
            curriculumSummary.textContent = '';
            gradesSummary.textContent = '';
            
            const checkedCurriculum = document.querySelector('input[name="curriculum_file"]:checked');
            if(checkedCurriculum) checkedCurriculum.checked = false;
            
            const checkedGrades = document.querySelector('input[name="grades_file"]:checked');
            if(checkedGrades) checkedGrades.checked = false;


        } catch (error) {
            showModal('Calculation Error', error.message);
        } finally {
            calculateBtn.disabled = false;
            calculateBtn.textContent = 'Calculate Final Grades';
            updateUIState();
        }
    });

    function displayResults(resultsData) {
        resultsDisplay.classList.remove('hidden');
        if (!resultsData || resultsData.length === 0) {
            resultsContent.innerHTML = '<p class="text-gray-500">No results to display. The source data might be incomplete.</p>';
        } else {
            const headers = Object.keys(resultsData[0]);
            const headerCells = headers.map(h => `<th class="py-2 px-4 font-semibold">${h.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`).join('');
            const bodyRows = resultsData.map(row => {
                const cells = headers.map(header => `<td class="py-3 px-4">${row[header]}</td>`).join('');
                return `<tr class="border-b">${cells}</tr>`;
            }).join('');
            resultsContent.innerHTML = `
                <div class="table-container border rounded-lg">
                    <table class="w-full text-left"><thead class="bg-gray-100 sticky top-0"><tr>${headerCells}</tr></thead><tbody class="divide-y">${bodyRows}</tbody></table>
                </div>`;
        }
    }

    // Initial setup on page load
    document.addEventListener('DOMContentLoaded', () => {
        fetchAndDisplayFiles('/api/curriculums', curriculumListDiv, loadCurriculumBtn, 'curriculum');
        fetchAndDisplayFiles('/api/grades', gradesListDiv, loadGradesBtn, 'grades');
        updateUIState();
    });
</script>
</body>
</html>
<!DOCTYPE html>